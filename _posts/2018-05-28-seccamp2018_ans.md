---
layout: post
date: 2018-05-28
title: seccamp2018開発と運用トラック 応募課題
tags: [seccamp2018]
excerpt : seccamp2018開発と運用トラック 応募課題
private : true

---

開発と運用トラック 応募課題

## 共通問題

### 問1
> ブログや、Twitter、GitHub、Slideshareなど公開している活動や資料があれば、URL等を記載してください。

- ブログ
  - [exploit.moe](https://exploit.moe)
- Twitter
  - [ノノノノ (no\_\_\_\_\_\_\_nonono)](https://twitter.com/no_______nonono)
- GitHub
  - [HayatoDoi](https://github.com/HayatoDoi)
- 過去に発表したスライド
  - <https://goo.gl/6TrmfL>

### 問2
> セキュリティ・キャンプ地方大会などのイベントに参加していれば、それを記入してください。

- セキュリティキャンプ九州大会2016

### 問3
> 自分のスキルについて、得意としている、あるいは得意としたい技術領域について、
> なぜその技術領域が好きなのか、その技術領域でどんな世界を作っていきたいのか、
> 好きなだけ語ってください。

　私が得意としている技術はネットワークです。人と人とがSNSで繋がり、SNS等のアプリケーションがネットワークで繋がります。人と人がインターネットを介して繋がる為にはネットワークが一番大切だと考えています。  
　私は、高速でセキュアなネットワークを構築して人が安全にインターネットを使える世界を作っていきたいと考えています。  
　ネットワークにセキュリティの機構を実装するものにIPSなどがあります。IPSはパソコンに通信が行く前にIPSがパケットの中身を全部調べ不正なパケットであるかを調べ、不正であればそのパケットを破棄します。この処理はとても時間がかかりオープンソースで有名なSnortでは10Gbpsにしか対応していません。日本のバックボーンネットワークに使える高速な不正なパケットを検出・破棄が出来るIPSを開発し、日本のネットワークをセキュアなネットワークへするのが僕の夢です。

### 問4
> あなたが今まで作ってきたソフトウェアにはどのようなものがありますか？
> また、それらはどんな言語やライブラリを使って作ったのか、
> どこにこだわって作ったのか、たくさん自慢してください。

- もふもふしよ♥
  - 詳細 : 
    これは、私が初めて作成したゲームです。
    NEW GAMEという漫画を読んで自分もゲームを作成してみたくなり作成しました。
    ゲームの内容はシンプルです。20秒間にタイプした回数を数え、ゲーム終了後スコアサーバを点数を送り、ランキングを表示させるというものです。
    プログラミング言語はC#を使いました。はじめ使うオブジェクト指向型プログラミング言語で戸惑いましたが、書きながら勉強して何とか完成させることができました。
    完成させたあと、知り合い達にプレイしてほしく大学のネットワークにスコアサーバを建ててゲームを公開していました。
    このゲームですが、チート対策を全く考えて作っていなくて多くの方法でスコアを改ざんすることが出来ました。チート対策をすると自分の作成したものがより強いプログラムとなるのがとても楽しく、この時期からセキュリティを真剣に勉強しようと考え始めました。
  - 発表資料 : 
    - <https://www.slideshare.net/HayatoDoi1/ss-62636853>
    - <https://www.slideshare.net/HayatoDoi1/ss-62629559>

- もふもふしよ♥♥
  - 詳細 : 
    これは上記のもふもふしよ♥を改良してチート対策を施したものになります。
    対策したチート方法は「メモリの改ざん」「パケットの偽装」「ソースコードの復元」の三つです。「メモリの改ざん」は簡易暗号(XOR)を使ってメモリの中に素のデータが入らないようにし、暗号化したデータをいくつかメモリの中に入れて全部書き換えないと正しいデータとして認識しないようにしました。「パケットの偽装」はアプリケーションとサーバ間で通信を改ざんしてスコアデータで書き換えられないようにTLSで通信するようにしました。「ソースコードの復元」はC#で作ったアプリケーションですので、デコンパイラなどを使いソースコードをそのまま復元されないように難読化ツールを使って難読化させました。
    アプリケーションを完成させた後1年間ほど外部に公開していたのですが、数人チートを使っていたためまだまだ対策が必要だと考えます。
    これからは、「アプリケーションをC++で作りデコンパイルに強くする」「サーバ内にスコアデータを常に持ち続けユーザ側から改ざん出来ないようにする」などの改良を加えたいと思います。
  - ソースコード :
    - アプリケーション : <https://github.com/HayatoDoi/MofuMofu2>
    - サーバ : <https://github.com/HayatoDoi/MofuMofu2_ScoreServer>
  - 発表資料 : <https://drive.google.com/file/d/0B-G9PtUAnjD0Njk5OVowUGgzZmM/view?usp=sharing>

- HarekazeCTF2018のスコアサーバ
  - 詳細 : 
    - これは私の所属しているCTFチームでオンラインCTFを開催したときのスコアサーバです。
    - １万人のユーザが同時アクセスしてきても各ページ1秒以内にレスポンスが返せるように設計されております。また、知っている限りの脆弱性を試し徹底的に脆弱性をつぶしました。
    開発中に常にチームメンバ内でサーバを公開して、DDoSや脆弱性調査を行ってもらいました。開発初期の段階ではすぐにサーバが落ちてしまい、ひぃひぃ言いながら徹夜で直していたのは良い思い出です。
    - アプリケーションを水平分散が出来るように設計しています([図1](/img/seccamp2018_ans/request_flow.jpg))。これによってアプリケーションをいくつか立てることによってリクエストを分散させることができます。水平分散を行うにあたって「セッションデータの共通化」「静的ファイルの共通化」という2つの問題がありました。「セッションデータの共通化」問題とはPHP等のプログラミング言語でセッションを発行した際、アプリケーション内にセッション情報されてしまうため、最初にリクエストを受け付けるNginxがセッション情報を持っていないアプリケーションにリクエストを渡してしまった場合セッション情報がわからなくなってしまうという問題です。これの解決方法として、「Nginxを高機能なロードバランサに変え、セッション情報を持っているアプリケーションにリクエストを送る」「セッション情報を保持するサーバを立てアプリケーション全体で共通化させる」の2つが挙げられます。前者の高機能なロードバランサとしてAWSのElastic Load Balancer等があるのですが今回のインフラ的に使用出来なかったので、後者を選択しました。アプリケーションはgolangのirisというフレームワークを用いて作っていたのですが、標準でRedisにセッションを保存することが出来るのでとても簡単でした。「静的ファイルの共通化」とは、アプリケーションにファイルをアップロードした時アプリケーション内に保存してしまったらほかのアプリケーションからファイルが見えなくなってしまう問題です。ファイルサーバを立ち上げ、アプリケーションサーバからREST APIで転送したら良かったのですが開発が間に合わず、インフラ担当の人が直接転送していました。HarekazeCTF2019ではREST APIを実装したいです。
    - データベースは([図2](/img/seccamp2018_ans/HarekazeCTF_DB_ER.jpg))のように設計しております。これによってチームとユーザを分けて登録することで正確な参加者数がわかる。また間違ったフラグも登録するためのフラグの正解率や誤フラグ等を取り出すこと・ソロで参加して1位だった人などを取り出すことが出来ます。しかしこの設計ではリレーショナルデータベースモデル独特のほしいデータを取り出すのにとても時間がかかる問題が発生します。例えば、チームランキングを取り出すとき、
    ```sql
    SELECT team_name,
        SUM(CASE WHEN score_table.create_time = (SELECT MIN(answer.create_time) FROM answer
                INNER JOIN question
                ON question.id = answer.question_id AND question.flag = answer.flag
                WHERE question.id = score_table.question_id )
        THEN score+10
        ELSE score
        END ) AS score_sum
    FROM (
        SELECT team.name AS team_name, question.id AS question_id, IFNULL(question.score, 0) AS score, MIN(answer.create_time) AS create_time
            FROM team
            RIGHT JOIN user
                ON user.team_id = team.id
            RIGHT JOIN answer
                ON answer.user_id = user.id
            INNER JOIN question
                ON question.id = answer.question_id AND question.flag = answer.flag
            GROUP BY team.name, question.id
        ) score_table
    GROUP BY score_table.team_name
    ORDER BY score_sum DESC, MAX(create_time)
    ```
    このようなクエリを発行する必要があり、レスポンスが帰ってくるのに6分ぐらいかかります。これを改善するためにRedisにデータベースのキャッシュを作りそれを呼び出すことでレスポンス速度あげました。具体的に言うとチーム作成時にキャッシュの中にスコア0点を入れて、問題正解時に得点を加算していくといものです。しかしこれだけでは、チーム数が増えるとチーム数分redisにアクセスして得点を習得しないといけないためレスポンス速度が落ちていきます。これを改善するためにRedisサーバ内部でLuaスクリプトを回し全チームのスコアを一回のアクセスで習得出来るようにしました。このような改善をすることで最初は6分であったレスポンスが60ミリ秒にすることが出来ました。
    - このアプリケーションを使ってオンラインCTFを開催したことで、多くの問題が見つかっており2019年のCTFでは改善していきたいと考えています。

  - ソースコード : <https://github.com/TeamHarekaze/HarekazeCTF2018-server>

### 問5
> あなたがこれまで利用したことがあるインターネットサービスの中で一番すごい！と思ったものについて、
> 技術的なのか、仕組み的なのか、ビジネス的なのか、
> どんなところがすごいと思ったのかを説明してください。

### 問6
> 今年のセキュリティ・キャンプ全国大会で受講したいと思っている講義は何ですか？
> そこで、どのようなことを学びたいですか？なぜそれを学びたいのですか？
> 講義を担当する講師に響くようにアピールしてください(複数可)

- クラウド・ホスティングサービスのセキュリティと運用技術の研究
- 攻防型CTFによるWebオンラインゲームのチート行為の体験
- シリアル通信から学ぶBadUSB自作演習


## 選択問題

以下の中から、2問以上を選んで回答してください。

### 問1
> これまでに解析したことがあるソフトウェアについて、 その戦略や手法や結果、苦労した点、学びがあった点など、好きなだけ語ってください。

  解析したことがあるソフトウェアは大学の学生ポータルです。  
  解析のための戦略としては、アプリケーションの全体像を抜き出し怪しい部分を徹底的に攻撃しました。  
  手法としては、
  - HTTPのレスポンスヘッダの中にServerの項目があればそのwebサーバ脆弱性をついてみる
  - cookieの中にPHPSESSIDがあればPHPの脆弱性をついてみる
  - cookieの中にuser名が入っていれば書き換えてみる
  - POST/GETパラメータに名列番号,学籍番号等が入っていれば書き換えてみる
  - 入力フォームがあればscriptタグを埋め込んでみる
  - 検索フォームがあればSQL文を入力してみる
  
  その結果5つほどの脆弱性を見つけ修正してもらうことが出来ました。

  苦労した点、学びがあった点
  - 今まではプロキシツールを使ってPOST/GETのパラメータをかえていたのですが、大学の学生ポータルはHTTPSのサイトであるためプロキシツールを使うことが出来ませんでした。その対策として`Firefoxのパケットの編集->再送信`を使ったり、デベロッパーツールからリクエストヘッダーを抜き出してpythonでリクエストを生成するなど、HTTP通信仕組みに詳しくなりました。
  - 大学の事務員さんに脆弱性を報告するときに、どのような脆弱性かが分かりやすいように報告出来るようにしました。事務員さんには脆弱性によってどのような危険があるかを伝え、クリティカルなものであれば開発部の人に直接伝えれるように時間をとってもらい、非クリティカルであれば事前に資料を作っていき開発部の人に後で見てもらえるようにしました。今はもっと気軽に脆弱性報告が出来るように大学と連携して環境作りをしています。

### 問2
> 「1000万人が利用するTwitterみたいなサービス」をあなたが開発することになったとしたら、
> 予算はあるとして、どんなアーキテクチャで設計しますか？
> 具体的に利用するミドルウェアやライブラリまで思い浮かぶ人はそこまで踏み込んで書いてください。

#### アーキテクチャ
- 垂直分散システムで解決する方法!!
  -  垂直分散システムとはweb・アプリケーション・データベースをそれぞれ1つのサーバにおくアーキテクチャで、サーバをハイスッペクにすることで1000万人のリクエストをさばくことが出来ます。今までなら1000万人のリクエストさばく事ができるパソコン用意することが出来なかったため、水平分散システムが使われていました。近年はクラウドの発達によりハイスペックなサーバを簡単に構築出来るようになりました。垂直分散システムの採用例としてポケモンGOが挙げられます。  
    ![/img/seccamp2018_ans/vertical_distribution_architecture.jpg](/img/seccamp2018_ans/vertical_distribution_architecture.jpg)

- 水平分散システムで解決する方法!!
  - 水平分散システムとはweb・アプリケーション・データベースを複数台のサーバにおくアーキテクチャで、サーバの台数を増やすことで1000万人のリクエストをさばくことが出来ます。サーバの監視・サーバの台数を増やすなど手間のかかる部分があるますが、AWSのCloudWatch, Auto Scaling等を使用することで比較的簡単に構築することが出来ます。水平分散システムの採用例としてFGOが挙げられます。  
    ![/img/seccamp2018_ans/horizontal_distribution_architecture.jpg](/img/seccamp2018_ans/horizontal_distribution_architecture.jpg)

- 垂直分散システム vs 水平分散システム
  - 垂直分散システムのメリット・デメリット
    - メリット : アプリケーションの開発がとても簡単
    - デメリット : サーバのコストがとても高い
    - デメリット : 1つのサーバで障害が起きた時サービスが止まる
  - 水平分散システムのメリット・デメリット
    - リクエストの数が少ない時はサーバの台数を少なくすることが出来るため、サーバのコストを下げることが出来る
    - メリット :　障害でサーバが落ちた時、別のサーバにリクエストを割り振ることでサービスを止めない
    - デメリット : アプリケーションが複雑になりため、開発が難しい
  - どちらも一長一短であるが、個人的に水平分散システムの方がアプリケーション構築がやりがいがあるので水平分散システムをオススメします。
  
#### ミドルウェア
優れたアーキテクチャで設計してあってもミドルウェアの設定を誤れば多くのリクエストをさばくのは難しくなります。  
web(nginx), アプリケーション, データベース(MySQL, Redis)の気をつけるべき設定を書きます。
- web(nginx)
  - 静的ファイルはnginxから配信する
  - css, javascriptなどは事前gzip圧縮で配信する
  - 画像ファイル等の更新頻度の低いファイル・ページはCache-Controlを使いアクセス数を減らす
  - タイムライン等の更新頻度が高いページはデータをキャッシュしないで、どんどん送信させる
  - Nginx本体のプロセス数をautoにする
  - 1つのプロセスが使用できるコネクション数を環境に合わせる
  - Linuxのepollを使う
  - レスポンスヘッダとファイルの内容をまとめて送る
- アプリケーション
  - スロークエリログからスロークエリを見つけ改善する
  - alpを使いレスポンスの遅いページを見つけだし改善する
  - なるべくforループの中でSQLを発行しないようにする
  - ファイル書き込み等を減らしメモリを使うようにする
- データベース(MySQL, Redis)
  - `SLECT COUNT(*) FROM user`等の全テーブルを数える部分はRedisを使い`INSERT`する度にカウンターを回し数えて行く
  - よく結合するテーブルにはindexを張る
  - 不要なデータベースは積極的捨てていく

#### 参考文献

今回の課題を解くにあたってゲームサーバインフラの記事を読んでいたが、かなり面白かったでの読んで欲しいです。
- [Nianticの求人から推測する『Pokémon GO(ポケモンGO)』のサーバ構成](https://qiita.com/shibacow/items/1ac6f65100252b78a707)
- [[レポート] Fate/Grand Orderにおける、ディライトワークス流AWS導入＆活用術 ](https://dev.classmethod.jp/cloud/aws/fatego/)
- [ドラゴンクエストXは「世界は一つ」を実現するためにどのようなサーバ構成にしているのか？](http://gigazine.net/news/20120824-dragonquest-backstage-cedec2012/)
